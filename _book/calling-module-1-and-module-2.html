<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>FARM: simulating the spread of agriculture through cultural phylogenies</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook.">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="FARM: simulating the spread of agriculture through cultural phylogenies" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="Conffusion_matrix_all.png" />
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="FARM: simulating the spread of agriculture through cultural phylogenies" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="twitter:image" content="Conffusion_matrix_all.png" />

<meta name="author" content="Ty Tuff, Bruno Vilela, and Carlos Botero">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="module-2-space-and-phylogeny-summary-statistics.html">
<link rel="next" href="running-module-1-and-module-2-on-the-cluster.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="spatial-scaffolding-for-the-simulations.html"><a href="spatial-scaffolding-for-the-simulations.html"><i class="fa fa-check"></i><b>2</b> Spatial scaffolding for the simulations</a></li>
<li class="chapter" data-level="3" data-path="rule-sets.html"><a href="rule-sets.html"><i class="fa fa-check"></i><b>3</b> Rule sets</a><ul>
<li class="chapter" data-level="3.1" data-path="rule-sets.html"><a href="rule-sets.html#simulation"><i class="fa fa-check"></i><b>3.1</b> Simulation:</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="module-1-simulation-to-produce-a-world-and-a-tree.html"><a href="module-1-simulation-to-produce-a-world-and-a-tree.html"><i class="fa fa-check"></i><b>4</b> Module 1: Simulation to produce a world and a tree</a><ul>
<li class="chapter" data-level="4.1" data-path="module-1-simulation-to-produce-a-world-and-a-tree.html"><a href="module-1-simulation-to-produce-a-world-and-a-tree.html#inputs"><i class="fa fa-check"></i><b>4.1</b> Inputs</a></li>
<li class="chapter" data-level="4.2" data-path="module-1-simulation-to-produce-a-world-and-a-tree.html"><a href="module-1-simulation-to-produce-a-world-and-a-tree.html#module-1-functions"><i class="fa fa-check"></i><b>4.2</b> Module 1 functions</a></li>
<li class="chapter" data-level="4.3" data-path="module-1-simulation-to-produce-a-world-and-a-tree.html"><a href="module-1-simulation-to-produce-a-world-and-a-tree.html#push-versions"><i class="fa fa-check"></i><b>4.3</b> Push versions</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html"><i class="fa fa-check"></i><b>5</b> Module 2: Space and phylogeny summary statistics</a><ul>
<li class="chapter" data-level="5.1" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#phylogenetic-summary-statistics"><i class="fa fa-check"></i><b>5.1</b> Phylogenetic summary statistics</a><ul>
<li class="chapter" data-level="5.1.1" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#introduction-and-framework"><i class="fa fa-check"></i><b>5.1.1</b> Introduction and framework</a></li>
<li class="chapter" data-level="5.1.2" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#alpha-diversity-metrics"><i class="fa fa-check"></i><b>5.1.2</b> Alpha diversity metrics</a></li>
<li class="chapter" data-level="5.1.3" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#pairwise-distance-between-tips"><i class="fa fa-check"></i><b>5.1.3</b> Pairwise distance between tips</a></li>
<li class="chapter" data-level="5.1.4" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#nearest-phylogenetic-neighbor"><i class="fa fa-check"></i><b>5.1.4</b> Nearest phylogenetic neighbor</a></li>
<li class="chapter" data-level="5.1.5" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#phylogenetic-isolation"><i class="fa fa-check"></i><b>5.1.5</b> Phylogenetic isolation</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#beta-diversity"><i class="fa fa-check"></i><b>5.2</b> Beta diversity</a></li>
<li class="chapter" data-level="5.3" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#tree-topology"><i class="fa fa-check"></i><b>5.3</b> Tree topology</a></li>
<li class="chapter" data-level="5.4" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#macroevolutionary-rates"><i class="fa fa-check"></i><b>5.4</b> Macroevolutionary rates</a></li>
<li class="chapter" data-level="5.5" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#spatial-locations"><i class="fa fa-check"></i><b>5.5</b> Spatial Locations</a></li>
<li class="chapter" data-level="5.6" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#module2-returns-these-two-matrices-as-a-list"><i class="fa fa-check"></i><b>5.6</b> Module2() returns these two matrices as a list</a><ul>
<li class="chapter" data-level="5.6.1" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#here-is-the-exact-version-in-r"><i class="fa fa-check"></i><b>5.6.1</b> Here is the exact version in R</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="module-2-space-and-phylogeny-summary-statistics.html"><a href="module-2-space-and-phylogeny-summary-statistics.html#references"><i class="fa fa-check"></i><b>5.7</b> References</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="calling-module-1-and-module-2.html"><a href="calling-module-1-and-module-2.html"><i class="fa fa-check"></i><b>6</b> Calling Module 1 and Module 2</a><ul>
<li class="chapter" data-level="6.1" data-path="calling-module-1-and-module-2.html"><a href="calling-module-1-and-module-2.html#run-the-simulation-to-a-specified-timestep-and-then-save-one-output"><i class="fa fa-check"></i><b>6.1</b> Run the simulation to a specified timestep and then save one output</a></li>
<li class="chapter" data-level="6.2" data-path="calling-module-1-and-module-2.html"><a href="calling-module-1-and-module-2.html#run-simulations-for-a-specified-time-but-run-stats-and-save-timesteps-along-the-way"><i class="fa fa-check"></i><b>6.2</b> Run simulations for a specified time but run stats and save timesteps along the way</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="running-module-1-and-module-2-on-the-cluster.html"><a href="running-module-1-and-module-2-on-the-cluster.html"><i class="fa fa-check"></i><b>7</b> Running Module 1 and Module 2 on the cluster</a><ul>
<li class="chapter" data-level="7.1" data-path="running-module-1-and-module-2-on-the-cluster.html"><a href="running-module-1-and-module-2-on-the-cluster.html#not-for-the-faint-of-hart"><i class="fa fa-check"></i><b>7.1</b> Not for the faint of hart</a></li>
<li class="chapter" data-level="7.2" data-path="running-module-1-and-module-2-on-the-cluster.html"><a href="running-module-1-and-module-2-on-the-cluster.html#bash-scripts"><i class="fa fa-check"></i><b>7.2</b> Bash scripts</a></li>
<li class="chapter" data-level="7.3" data-path="running-module-1-and-module-2-on-the-cluster.html"><a href="running-module-1-and-module-2-on-the-cluster.html#passing-arguements-to-r-script"><i class="fa fa-check"></i><b>7.3</b> Passing arguements to R-script</a></li>
<li class="chapter" data-level="7.4" data-path="running-module-1-and-module-2-on-the-cluster.html"><a href="running-module-1-and-module-2-on-the-cluster.html#accessing-and-working-with-the-cluster"><i class="fa fa-check"></i><b>7.4</b> Accessing and working with the cluster</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="module-3-analysing-results-produce-from-modules-1-and-2.html"><a href="module-3-analysing-results-produce-from-modules-1-and-2.html"><i class="fa fa-check"></i><b>8</b> Module 3: Analysing results produce from Modules 1 and 2</a><ul>
<li class="chapter" data-level="8.1" data-path="module-3-analysing-results-produce-from-modules-1-and-2.html"><a href="module-3-analysing-results-produce-from-modules-1-and-2.html#organize-data"><i class="fa fa-check"></i><b>8.1</b> Organize data</a></li>
<li class="chapter" data-level="8.2" data-path="module-3-analysing-results-produce-from-modules-1-and-2.html"><a href="module-3-analysing-results-produce-from-modules-1-and-2.html#diagnostics"><i class="fa fa-check"></i><b>8.2</b> Diagnostics</a></li>
<li class="chapter" data-level="8.3" data-path="module-3-analysing-results-produce-from-modules-1-and-2.html"><a href="module-3-analysing-results-produce-from-modules-1-and-2.html#random-forest-analysis"><i class="fa fa-check"></i><b>8.3</b> Random Forest Analysis</a><ul>
<li class="chapter" data-level="8.3.1" data-path="module-3-analysing-results-produce-from-modules-1-and-2.html"><a href="module-3-analysing-results-produce-from-modules-1-and-2.html#trainingbuilding"><i class="fa fa-check"></i><b>8.3.1</b> Training/Building</a></li>
<li class="chapter" data-level="8.3.2" data-path="module-3-analysing-results-produce-from-modules-1-and-2.html"><a href="module-3-analysing-results-produce-from-modules-1-and-2.html#testing"><i class="fa fa-check"></i><b>8.3.2</b> Testing</a></li>
<li class="chapter" data-level="8.3.3" data-path="module-3-analysing-results-produce-from-modules-1-and-2.html"><a href="module-3-analysing-results-produce-from-modules-1-and-2.html#matching"><i class="fa fa-check"></i><b>8.3.3</b> Matching</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="module-3-analysing-results-produce-from-modules-1-and-2.html"><a href="module-3-analysing-results-produce-from-modules-1-and-2.html#run-a-single-random-forest-on-available-outputs"><i class="fa fa-check"></i><b>8.4</b> Run a single random forest on available outputs</a></li>
<li class="chapter" data-level="8.5" data-path="module-3-analysing-results-produce-from-modules-1-and-2.html"><a href="module-3-analysing-results-produce-from-modules-1-and-2.html#visualize-outputs-from-random-forest-analysis"><i class="fa fa-check"></i><b>8.5</b> Visualize outputs from Random Forest analysis</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">FARM: simulating the spread of agriculture through cultural phylogenies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="calling-module-1-and-module-2" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Calling Module 1 and Module 2</h1>
<p>Simulating 10000 replicates of each of the 4 hypothesized mechanisms (40000 total simulations) and then calculating summary statistics for all of those simulated worlds required a tremendous amount of computing power. We utilize a 1000-node cluster at Washington University in St.Â Louis and a 300-node cluster at MPI in Jena from August 2016 to January 2018 to first prototype the simulation and then run 1000 replicates of each hypothesized mechanism. Model development and prototyping took a full year and two major rebuilds to produce realistic worlds that could fit real world data. In that time, we changed modes of categorizing simulation outputs from approximate Bayesian computation (ABC) to random forest machine learning (CITE) because our simulations did not produce the linear posterior distributions required for ABC but we were able to work around those limitations using a supervised random forest algorithm.</p>
<p>There are two versions of this script, the first is for running each simulation to the end and then saving the final step as the output of the model and the second is to save outputs along the way so we can evaluate how different models change through time.</p>
<div id="run-the-simulation-to-a-specified-timestep-and-then-save-one-output" class="section level2">
<h2><span class="header-section-number">6.1</span> Run the simulation to a specified timestep and then save one output</h2>
<p>Here is the first, and primary, version:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">#####################################################################

<span class="co"># Run the full model in a cluster. This version writes files to a cluster output folder.</span>
<span class="co"># rm(list = ls())</span>
<span class="co"># install.packages(&quot;~/Desktop/FARM_1.0.tar.gz&quot;, repos=NULL, type=&quot;source&quot;)</span>


#####################################################################
## need to document which functions we use from each of these libraries. 
<span class="kw">library</span>(ape)
<span class="kw">library</span>(spdep)
<span class="kw">library</span>(Rcpp)
<span class="kw">library</span>(msm)
<span class="kw">library</span>(FARM)


sim_run_cluster &lt;-<span class="st"> </span><span class="cf">function</span>(replicate_cycle, myWorld, number_of_time_steps, nbs,
                            number_of_tips, number_of_neighbors, origins, <span class="dt">start =</span> <span class="ot">NULL</span>) {
  <span class="co"># Calls the full simulation script </span>
  <span class="co">#  </span>
  <span class="co"># Purpose: Need to wrap the entire simulation script into a function so it can be called in parallel from a cluster call  </span>
  <span class="co">#</span>
  <span class="co"># Args:</span>
  <span class="co">#    replicate_cycle: An integer indicating the replicate number of a simulation. This variable is used in this function to label        </span>
  <span class="co">#         the saved output file and control the number of replicates run by the cluster.</span>
  <span class="co">#</span>
  <span class="co">#    combo_number: An interger between 1 and 31 indicating the combinations of S, E, A, D, and T modules to be included </span>
  <span class="co">#         in the simulation. The full list of these combinations can be printed using the function combo_of_choice(28, TRUE).</span>
  <span class="co">#         We are currently using combinations 25,28,29,and 31 as our four competing models for the spread of agriculture.  </span>
  <span class="co">#</span>
  <span class="co">#    myWorld: Matrix that defines the scope of the available world and acts as a data hub for organizing and reporting      </span>
  <span class="co">#         results from the different elements of the simulation. </span>
  <span class="co">#</span>
  <span class="co">#    number_of_time_steps: An integer indicating how many iterations the simulation will calculated before writing the data </span>
  <span class="co">#         file. </span>
  <span class="co">#</span>
  <span class="co">#    nbs: A list of the available neighbors for each spatial point. This is passed to the function for calculating the interaction </span>
  <span class="co">#         of neighbors through time. </span>
  <span class="co">#</span>
  <span class="co">#    number_of_tips: An interger indicating the number of tree tips the simulation should be truncated to. The default is to </span>
  <span class="co">#         include all the available tips (e.g. 1254 for human languages). </span>
  <span class="co">#</span>
  <span class="co"># Returns: </span>
  <span class="co">#    myOut: A list object containing a &#39;phylo&#39; tree object called mytree in the first position and the myWorld matrix of </span>
  <span class="co">#         spatial and tree data in the second position </span>
  <span class="co">#     </span>
  

  x1 &lt;-<span class="st"> </span><span class="dv">4</span> <span class="co">#Number of runs per core</span>
  sampleer &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">6</span>), x1)
  <span class="co">#if (replicate_cycle != 1) {</span>
  <span class="co">#  replicate_cycle &lt;- ((replicate_cycle - 1) * x1) + 1</span>
 <span class="co"># }</span>
 <span class="co"># replicate_cycle &lt;- replicate_cycle:(replicate_cycle + (x1 - 1))</span>
  <span class="cf">for</span> (count <span class="cf">in</span> sampleer) {
  independent &lt;-<span class="st"> </span><span class="dv">1</span> 

    
    <span class="co"># Probability of Arisal</span>
    prob_choose_a &lt;-<span class="st"> </span><span class="kw">rev</span>(<span class="kw">sort</span>(<span class="kw">rexp</span>(<span class="dv">4</span>, <span class="dt">rate =</span> <span class="dv">9</span>)))
    prob_choose_a &lt;-<span class="st"> </span>prob_choose_a[<span class="kw">c</span>(<span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">2</span>), <span class="kw">sample</span>(<span class="dv">3</span><span class="op">:</span><span class="dv">4</span>, <span class="dv">2</span>))]
    prob_choose_a[<span class="dv">3</span>] &lt;-<span class="st"> </span><span class="dv">0</span>
    P.Arisal0  &lt;-<span class="st"> </span><span class="kw">parameters</span>(prob_choose_a[<span class="dv">1</span>], prob_choose_a[<span class="dv">4</span>],
                             prob_choose_a[<span class="dv">3</span>], prob_choose_a[<span class="dv">2</span>],
                             <span class="st">&quot;Env_NonD&quot;</span>, <span class="st">&quot;Env_D&quot;</span>,
                             <span class="st">&quot;Evol_to_F&quot;</span>, <span class="st">&quot;Evol_to_D&quot;</span>)
    <span class="co"># P.Arisal0 is the one you should change the parameters</span>
    P.Arisal &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dt">ncol =</span> <span class="dv">2</span>, <span class="dt">nrow =</span> <span class="kw">nrow</span>(myWorld)) <span class="co"># probability per cell</span>
    <span class="kw">colnames</span>(P.Arisal) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Evolve_to_F&quot;</span>, <span class="st">&quot;Evolve_to_D&quot;</span>)
    Env.Dom &lt;-<span class="st"> </span>myWorld[, <span class="dv">7</span>] <span class="op">==</span><span class="st"> </span><span class="dv">2</span>
    P.Arisal[Env.Dom, <span class="dv">1</span>] &lt;-<span class="st"> </span>P.Arisal0[<span class="dv">1</span>, <span class="dv">2</span>]
    P.Arisal[<span class="op">!</span>Env.Dom, <span class="dv">1</span>] &lt;-<span class="st"> </span>P.Arisal0[<span class="dv">1</span>, <span class="dv">1</span>]
    P.Arisal[Env.Dom, <span class="dv">2</span>] &lt;-<span class="st"> </span>P.Arisal0[<span class="dv">2</span>, <span class="dv">2</span>]
    P.Arisal[<span class="op">!</span>Env.Dom, <span class="dv">2</span>] &lt;-<span class="st"> </span>P.Arisal0[<span class="dv">2</span>, <span class="dv">1</span>]
    
    <span class="kw">colnames</span>(P.Arisal) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Prob_of_Foraging&quot;</span>, <span class="st">&quot;Prob_of_Domestication&quot;</span>)
    P.Arisal[<span class="kw">which</span>(origins <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>), <span class="dv">2</span>]  &lt;-<span class="st"> </span><span class="dv">0</span>
    
    #####
    <span class="co">#prob_choose &lt;- runif(12, 0.01, 1)</span>
    <span class="co">#sub &lt;- (prob_choose[1] - 0.01)</span>
    <span class="co">#sub &lt;- ifelse(sub &lt; .1, .1, sub)</span>
    <span class="co">#prob_choose[c(4)] &lt;- runif(1, 0.01, sub)</span>
    <span class="co">#prob_choose[c(5)] &lt;- runif(1, 0.1, 1) # High extinction</span>
    <span class="co">#prob_choose[c(6)] &lt;- runif(1, 0, (prob_choose[3] - 0.01))</span>
    <span class="co">#prob_choose[c(9, 10, 12)] &lt;- runif(3, 0.01, prob_choose[11])</span>
    
    ####
    prob_choose &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">12</span>, <span class="dv">0</span>, <span class="dv">1</span>)
    top &lt;-<span class="st"> </span><span class="kw">min</span>(prob_choose[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)], <span class="dt">na.rm=</span><span class="ot">TRUE</span>)
    prob_choose[<span class="kw">c</span>(<span class="dv">2</span>)] &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, top)
    
    prob_choose[<span class="kw">c</span>(<span class="dv">5</span>)] &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, prob_choose[<span class="kw">c</span>(<span class="dv">2</span>)]) 
    prob_choose[<span class="kw">c</span>(<span class="dv">6</span>)] &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, prob_choose[<span class="kw">c</span>(<span class="dv">5</span>)])
    prob_choose[<span class="kw">c</span>(<span class="dv">4</span>)] &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>, prob_choose[<span class="kw">c</span>(<span class="dv">6</span>)], prob_choose[<span class="kw">c</span>(<span class="dv">5</span>)])
    
        
    <span class="cf">if</span> (count <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {
      prob_choose[<span class="dv">7</span><span class="op">:</span><span class="dv">12</span>] &lt;-<span class="st"> </span><span class="dv">0</span>
    }
    <span class="cf">if</span> (count <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) {
      prob_choose[<span class="dv">9</span><span class="op">:</span><span class="dv">12</span>] &lt;-<span class="st"> </span><span class="dv">0</span>
    }
    <span class="cf">if</span> (count <span class="op">==</span><span class="st"> </span><span class="dv">3</span> <span class="op">|</span><span class="st"> </span>count <span class="op">==</span><span class="st"> </span><span class="dv">5</span>) {
      prob_choose[<span class="dv">7</span><span class="op">:</span><span class="dv">8</span>] &lt;-<span class="st"> </span><span class="dv">0</span>
      independent &lt;-<span class="st"> </span><span class="dv">0</span>
    }
    <span class="cf">if</span> (count <span class="op">==</span><span class="st"> </span><span class="dv">4</span> <span class="op">|</span><span class="st"> </span>count <span class="op">==</span><span class="st"> </span><span class="dv">6</span>) {
      independent &lt;-<span class="st"> </span><span class="dv">0</span>
    }
    
    
    P.speciation &lt;-<span class="st"> </span><span class="kw">parameters</span>(prob_choose[<span class="dv">1</span>], prob_choose[<span class="dv">1</span>],
                               prob_choose[<span class="dv">2</span>], prob_choose[<span class="dv">3</span>],
                               <span class="st">&quot;Env_NonD&quot;</span>, <span class="st">&quot;Env_D&quot;</span>, <span class="st">&quot;For&quot;</span>, <span class="st">&quot;Dom&quot;</span>)

    P.extinction  &lt;-<span class="st"> </span><span class="kw">parameters</span>(prob_choose[<span class="dv">4</span>], prob_choose[<span class="dv">4</span>],
                                prob_choose[<span class="dv">5</span>], prob_choose[<span class="dv">6</span>],
                                <span class="st">&quot;Env_NonD&quot;</span>, <span class="st">&quot;Env_D&quot;</span>, <span class="st">&quot;For&quot;</span>, <span class="st">&quot;Dom&quot;</span>)

    
    P.diffusion &lt;-<span class="st"> </span><span class="kw">parameters</span>(<span class="dv">0</span>, prob_choose[<span class="dv">7</span>],
                              prob_choose[<span class="dv">8</span>], <span class="dv">0</span>,
                              <span class="st">&quot;Target_For&quot;</span>, <span class="st">&quot;Target_Dom&quot;</span>,
                              <span class="st">&quot;Source_For&quot;</span>, <span class="st">&quot;Source_Dom&quot;</span>)
    
    P.TakeOver &lt;-<span class="st"> </span><span class="kw">parameters</span>(prob_choose[<span class="dv">9</span>], prob_choose[<span class="dv">10</span>],
                             prob_choose[<span class="dv">11</span>], prob_choose[<span class="dv">12</span>],
                             <span class="st">&quot;Target_For&quot;</span>, <span class="st">&quot;Target_Dom&quot;</span>,
                             <span class="st">&quot;Source_For&quot;</span>, <span class="st">&quot;Source_Dom&quot;</span>)
    multiplier &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># always 1 now.</span>
   <span class="cf">if</span> (count <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">4</span>) { 
        myOut &lt;-<span class="st"> </span><span class="kw">RunSimUltimate</span>(myWorld, P.extinction, P.speciation, 
                            P.diffusion, P.Arisal, P.TakeOver, nbs, independent,
                            <span class="dt">N.steps =</span> number_of_time_steps, <span class="dt">silent =</span> <span class="ot">FALSE</span>, 
                            <span class="dt">multiplier =</span> multiplier, <span class="dt">start =</span> start)
                            }
   <span class="cf">if</span> (count <span class="op">%in%</span><span class="st"> </span><span class="dv">5</span><span class="op">:</span><span class="dv">6</span>) {
        myOut &lt;-<span class="st"> </span><span class="kw">RunSimUltimate.push</span>(myWorld, P.extinction, P.speciation, 
                            P.diffusion, P.Arisal, P.TakeOver, nbs, independent,
                            <span class="dt">N.steps =</span> number_of_time_steps, <span class="dt">silent =</span> <span class="ot">FALSE</span>, 
                            <span class="dt">multiplier =</span> multiplier, <span class="dt">start =</span> start)
                            }
                            
                            
    <span class="co"># Count refers to the combo, 1 = null, 2 = diffusion, 3 = Takeover, 4 = full</span>
    <span class="kw">save</span>(myOut,  <span class="dt">file=</span> <span class="kw">paste0</span>(<span class="st">&quot;./Module_1_outputs/myOut_rep_&quot;</span>,
                              <span class="kw">formatC</span>(replicate_cycle, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>),
                              <span class="st">&quot;_combo_&quot;</span>,
                              <span class="kw">formatC</span>(count, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>),
                              <span class="st">&quot;_&quot;</span>,<span class="st">&quot;params&quot;</span>, <span class="st">&quot;_P.speciation_&quot;</span>,
                              <span class="kw">paste</span>(<span class="kw">formatC</span>(P.speciation, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>), <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;_P.extinct_&quot;</span>,
                              <span class="kw">paste</span>(<span class="kw">formatC</span>(P.extinction, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>), <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>), <span class="st">&quot;_P.diffus_&quot;</span>,
                              <span class="kw">paste</span>(<span class="kw">formatC</span>(P.diffusion, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>), <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>), <span class="st">&quot;_P.TO_&quot;</span>,
                              <span class="kw">paste</span>(<span class="kw">formatC</span>(P.TakeOver, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>), <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;_P.Arisal_&quot;</span>,
                              <span class="kw">paste</span>(<span class="kw">formatC</span>(P.Arisal0, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>), <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>),
                              <span class="st">&quot;_timesteps_&quot;</span>, number_of_time_steps, <span class="st">&quot;_NBS_&quot;</span>, number_of_neighbors, <span class="st">&quot;_.Rdata&quot;</span>))

    Sim_statistics &lt;-<span class="st"> </span><span class="kw">Module_2</span>(myOut)

    <span class="kw">save</span>(Sim_statistics, <span class="dt">file=</span> <span class="kw">paste0</span>(<span class="st">&quot;./Module_2_outputs/Sim_stats_rep_&quot;</span>,
                                      <span class="kw">formatC</span>(replicate_cycle, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>),
                                      <span class="st">&quot;_combo_&quot;</span>,
                                      <span class="kw">formatC</span>(count, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>),
                                      <span class="st">&quot;_&quot;</span>,<span class="st">&quot;params&quot;</span>, <span class="st">&quot;_P.speciation_&quot;</span>,
                                      <span class="kw">paste</span>(<span class="kw">formatC</span>(P.speciation, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>), <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;_P.extinct_&quot;</span>,
                                      <span class="kw">paste</span>(<span class="kw">formatC</span>(P.extinction, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>), <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>), <span class="st">&quot;_P.diffus_&quot;</span>,
                                      <span class="kw">paste</span>(<span class="kw">formatC</span>(P.diffusion, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>), <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>), <span class="st">&quot;_P.TO_&quot;</span>,
                                      <span class="kw">paste</span>(<span class="kw">formatC</span>(P.TakeOver, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>), <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;_P.Arisal_&quot;</span>,
                                      <span class="kw">paste</span>(<span class="kw">formatC</span>(P.Arisal0, <span class="dt">width =</span> <span class="dv">2</span>,<span class="dt">flag =</span> <span class="dv">0</span>), <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>),
                                      <span class="st">&quot;_timesteps_&quot;</span>, number_of_time_steps, <span class="st">&quot;_NBS_&quot;</span>, number_of_neighbors, <span class="st">&quot;_.Rdata&quot;</span>))
  }
  
}

#####################################################################
coords &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">apply</span>(language_centroids[, <span class="dv">3</span><span class="op">:</span><span class="dv">4</span>], <span class="dv">2</span>, as.numeric)) <span class="co">#coords</span>
conds &lt;-<span class="st"> </span><span class="kw">ifelse</span>(suitability2 <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)
conds[<span class="kw">is.na</span>(conds)] &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="kw">sum</span>(<span class="kw">is.na</span>(conds)), <span class="dt">replace =</span> <span class="ot">TRUE</span>) 
origins &lt;-<span class="st"> </span>language_centroids[, <span class="dv">5</span>]

##### Specify simulation parameters #################################

number_of_tips &lt;-<span class="st"> </span><span class="kw">length</span>(coords[,<span class="dv">1</span>])
number_of_time_steps_a &lt;-<span class="st"> </span><span class="dv">30000</span>
<span class="co">#replicate_cycle &lt;- c(1)  #number of replicates</span>
#####################################################################
<span class="kw">data</span>(<span class="st">&quot;parameters.table&quot;</span>)


<span class="kw">system.time</span>(
  myWorld &lt;-<span class="st"> </span><span class="kw">BuildWorld</span>(coords, conds)
)
number_of_neighbors &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">5</span><span class="op">:</span><span class="dv">9</span>,<span class="dv">1</span>)

nbs &lt;-<span class="st"> </span><span class="kw">knn2nb</span>(<span class="kw">knearneigh</span>(coords, <span class="dt">k =</span> number_of_neighbors, <span class="dt">longlat =</span> <span class="ot">TRUE</span>),
              <span class="dt">sym =</span> <span class="ot">TRUE</span>) <span class="co"># 7 symmetric neighbors</span>
n.obs &lt;-<span class="st"> </span><span class="kw">sapply</span>(nbs, length)
seq.max &lt;-<span class="st"> </span><span class="kw">seq_len</span>(<span class="kw">max</span>(n.obs))
nbs &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">sapply</span>(nbs, <span class="st">&quot;[&quot;</span>, <span class="dt">i =</span> seq.max))

<span class="kw">dim</span>(myWorld)


<span class="co"># NAI &lt;- 1000</span>
args &lt;-<span class="st"> </span><span class="kw">commandArgs</span>(<span class="dt">trailingOnly =</span> <span class="ot">FALSE</span>)
<span class="kw">print</span>(args)
NAI &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(args[<span class="dv">7</span>])
<span class="co">#setwd(&quot;~/Box Sync/colliding ranges/Simulations_humans/big world cluster outputs&quot;)</span>


<span class="co"># Starting point</span>
start &lt;-<span class="st"> </span><span class="kw">sample</span>((<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(language_centroids))[<span class="kw">as.logical</span>(language_centroids[, <span class="dv">6</span>])], <span class="dv">1</span>)

<span class="co">#sim_run_cluster(replicate_cycle = NAI,</span>
<span class="co">#                myWorld, number_of_time_steps = number_of_time_steps_a, </span>
<span class="co">#                nbs, number_of_tips = nrow(myWorld), number_of_neighbors= number_of_neighbors, #origins=origins,start = start)</span></code></pre></div>
</div>
<div id="run-simulations-for-a-specified-time-but-run-stats-and-save-timesteps-along-the-way" class="section level2">
<h2><span class="header-section-number">6.2</span> Run simulations for a specified time but run stats and save timesteps along the way</h2>
<p>Here is the second version</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">#####################################################################

<span class="co"># Run the full model in a cluster. This version writes files to a cluster output folder.</span>
<span class="co"># rm(list = ls())</span>
<span class="co"># install.packages(&quot;~/Desktop/FARM_1.0.tar.gz&quot;, repos=NULL, type=&quot;source&quot;)</span>


#####################################################################
## need to document which functions we use from each of these libraries. 
<span class="kw">library</span>(ape)
<span class="kw">library</span>(spdep)
<span class="kw">library</span>(Rcpp)
<span class="kw">library</span>(msm)
<span class="kw">library</span>(FARM)


sim_run_cluster &lt;-<span class="st"> </span><span class="cf">function</span>(replicate_cycle, myWorld, number_of_time_steps, nbs,
                            number_of_tips, number_of_neighbors, origins, <span class="dt">start =</span> <span class="ot">NULL</span>) {
  <span class="co"># Calls the full simulation script </span>
  <span class="co">#  </span>
  <span class="co"># Purpose: Need to wrap the entire simulation script into a function so it can be called in parallel from a cluster call  </span>
  <span class="co">#</span>
  <span class="co"># Args:</span>
  <span class="co">#    replicate_cycle: An integer indicating the replicate number of a simulation. This variable is used in this function to label        </span>
  <span class="co">#         the saved output file and control the number of replicates run by the cluster.</span>
  <span class="co">#</span>
  <span class="co">#    combo_number: An interger between 1 and 31 indicating the combinations of S, E, A, D, and T modules to be included </span>
  <span class="co">#         in the simulation. The full list of these combinations can be printed using the function combo_of_choice(28, TRUE).</span>
  <span class="co">#         We are currently using combinations 25,28,29,and 31 as our four competing models for the spread of agriculture.  </span>
  <span class="co">#</span>
  <span class="co">#    myWorld: Matrix that defines the scope of the available world and acts as a data hub for organizing and reporting      </span>
  <span class="co">#         results from the different elements of the simulation. </span>
  <span class="co">#</span>
  <span class="co">#    number_of_time_steps: An integer indicating how many iterations the simulation will calculated before writing the data </span>
  <span class="co">#         file. </span>
  <span class="co">#</span>
  <span class="co">#    nbs: A list of the available neighbors for each spatial point. This is passed to the function for calculating the interaction </span>
  <span class="co">#         of neighbors through time. </span>
  <span class="co">#</span>
  <span class="co">#    number_of_tips: An interger indicating the number of tree tips the simulation should be truncated to. The default is to </span>
  <span class="co">#         include all the available tips (e.g. 1254 for human languages). </span>
  <span class="co">#</span>
  <span class="co"># Returns: </span>
  <span class="co">#    myOut: A list object containing a &#39;phylo&#39; tree object called mytree in the first position and the myWorld matrix of </span>
  <span class="co">#         spatial and tree data in the second position </span>
  <span class="co">#     </span>
  

  x1 &lt;-<span class="st"> </span><span class="dv">4</span> <span class="co">#Number of runs per core</span>
  sampleer &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">6</span>), x1)
  <span class="co">#if (replicate_cycle != 1) {</span>
  <span class="co">#  replicate_cycle &lt;- ((replicate_cycle - 1) * x1) + 1</span>
 <span class="co"># }</span>
 <span class="co"># replicate_cycle &lt;- replicate_cycle:(replicate_cycle + (x1 - 1))</span>
  <span class="cf">for</span> (count <span class="cf">in</span> sampleer) {
  independent &lt;-<span class="st"> </span><span class="dv">1</span> 

    
    <span class="co"># Probability of Arisal</span>
    prob_choose_a &lt;-<span class="st"> </span><span class="kw">rev</span>(<span class="kw">sort</span>(<span class="kw">rexp</span>(<span class="dv">4</span>, <span class="dt">rate =</span> <span class="dv">9</span>)))
    prob_choose_a &lt;-<span class="st"> </span>prob_choose_a[<span class="kw">c</span>(<span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">2</span>), <span class="kw">sample</span>(<span class="dv">3</span><span class="op">:</span><span class="dv">4</span>, <span class="dv">2</span>))]
    prob_choose_a[<span class="dv">3</span>] &lt;-<span class="st"> </span><span class="dv">0</span>
    P.Arisal0  &lt;-<span class="st"> </span><span class="kw">parameters</span>(prob_choose_a[<span class="dv">1</span>], prob_choose_a[<span class="dv">4</span>],
                             prob_choose_a[<span class="dv">3</span>], prob_choose_a[<span class="dv">2</span>],
                             <span class="st">&quot;Env_NonD&quot;</span>, <span class="st">&quot;Env_D&quot;</span>,
                             <span class="st">&quot;Evol_to_F&quot;</span>, <span class="st">&quot;Evol_to_D&quot;</span>)
    <span class="co"># P.Arisal0 is the one you should change the parameters</span>
    P.Arisal &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dt">ncol =</span> <span class="dv">2</span>, <span class="dt">nrow =</span> <span class="kw">nrow</span>(myWorld)) <span class="co"># probability per cell</span>
    <span class="kw">colnames</span>(P.Arisal) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Evolve_to_F&quot;</span>, <span class="st">&quot;Evolve_to_D&quot;</span>)
    Env.Dom &lt;-<span class="st"> </span>myWorld[, <span class="dv">7</span>] <span class="op">==</span><span class="st"> </span><span class="dv">2</span>
    P.Arisal[Env.Dom, <span class="dv">1</span>] &lt;-<span class="st"> </span>P.Arisal0[<span class="dv">1</span>, <span class="dv">2</span>]
    P.Arisal[<span class="op">!</span>Env.Dom, <span class="dv">1</span>] &lt;-<span class="st"> </span>P.Arisal0[<span class="dv">1</span>, <span class="dv">1</span>]
    P.Arisal[Env.Dom, <span class="dv">2</span>] &lt;-<span class="st"> </span>P.Arisal0[<span class="dv">2</span>, <span class="dv">2</span>]
    P.Arisal[<span class="op">!</span>Env.Dom, <span class="dv">2</span>] &lt;-<span class="st"> </span>P.Arisal0[<span class="dv">2</span>, <span class="dv">1</span>]
    
    <span class="kw">colnames</span>(P.Arisal) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Prob_of_Foraging&quot;</span>, <span class="st">&quot;Prob_of_Domestication&quot;</span>)
    P.Arisal[<span class="kw">which</span>(origins <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>), <span class="dv">2</span>]  &lt;-<span class="st"> </span><span class="dv">0</span>
    
    #####
    <span class="co">#prob_choose &lt;- runif(12, 0.01, 1)</span>
    <span class="co">#sub &lt;- (prob_choose[1] - 0.01)</span>
    <span class="co">#sub &lt;- ifelse(sub &lt; .1, .1, sub)</span>
    <span class="co">#prob_choose[c(4)] &lt;- runif(1, 0.01, sub)</span>
    <span class="co">#prob_choose[c(5)] &lt;- runif(1, 0.1, 1) # High extinction</span>
    <span class="co">#prob_choose[c(6)] &lt;- runif(1, 0, (prob_choose[3] - 0.01))</span>
    <span class="co">#prob_choose[c(9, 10, 12)] &lt;- runif(3, 0.01, prob_choose[11])</span>
    
    ####
    prob_choose &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">12</span>, <span class="dv">0</span>, <span class="dv">1</span>)
    top &lt;-<span class="st"> </span><span class="kw">min</span>(prob_choose[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)], <span class="dt">na.rm=</span><span class="ot">TRUE</span>)
    prob_choose[<span class="kw">c</span>(<span class="dv">2</span>)] &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, top)
    
    prob_choose[<span class="kw">c</span>(<span class="dv">5</span>)] &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, prob_choose[<span class="kw">c</span>(<span class="dv">2</span>)]) 
    prob_choose[<span class="kw">c</span>(<span class="dv">6</span>)] &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, prob_choose[<span class="kw">c</span>(<span class="dv">5</span>)])
    prob_choose[<span class="kw">c</span>(<span class="dv">4</span>)] &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>, prob_choose[<span class="kw">c</span>(<span class="dv">6</span>)], prob_choose[<span class="kw">c</span>(<span class="dv">5</span>)])
    
        
    <span class="cf">if</span> (count <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {
      prob_choose[<span class="dv">7</span><span class="op">:</span><span class="dv">12</span>] &lt;-<span class="st"> </span><span class="dv">0</span>
    }
    <span class="cf">if</span> (count <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) {
      prob_choose[<span class="dv">9</span><span class="op">:</span><span class="dv">12</span>] &lt;-<span class="st"> </span><span class="dv">0</span>
    }
    <span class="cf">if</span> (count <span class="op">==</span><span class="st"> </span><span class="dv">3</span> <span class="op">|</span><span class="st"> </span>count <span class="op">==</span><span class="st"> </span><span class="dv">5</span>) {
      prob_choose[<span class="dv">7</span><span class="op">:</span><span class="dv">8</span>] &lt;-<span class="st"> </span><span class="dv">0</span>
      independent &lt;-<span class="st"> </span><span class="dv">0</span>
    }
    <span class="cf">if</span> (count <span class="op">==</span><span class="st"> </span><span class="dv">4</span> <span class="op">|</span><span class="st"> </span>count <span class="op">==</span><span class="st"> </span><span class="dv">6</span>) {
      independent &lt;-<span class="st"> </span><span class="dv">0</span>
    }
    
    
    P.speciation &lt;-<span class="st"> </span><span class="kw">parameters</span>(prob_choose[<span class="dv">1</span>], prob_choose[<span class="dv">1</span>],
                               prob_choose[<span class="dv">2</span>], prob_choose[<span class="dv">3</span>],
                               <span class="st">&quot;Env_NonD&quot;</span>, <span class="st">&quot;Env_D&quot;</span>, <span class="st">&quot;For&quot;</span>, <span class="st">&quot;Dom&quot;</span>)

    P.extinction  &lt;-<span class="st"> </span><span class="kw">parameters</span>(prob_choose[<span class="dv">4</span>], prob_choose[<span class="dv">4</span>],
                                prob_choose[<span class="dv">5</span>], prob_choose[<span class="dv">6</span>],
                                <span class="st">&quot;Env_NonD&quot;</span>, <span class="st">&quot;Env_D&quot;</span>, <span class="st">&quot;For&quot;</span>, <span class="st">&quot;Dom&quot;</span>)

    
    P.diffusion &lt;-<span class="st"> </span><span class="kw">parameters</span>(<span class="dv">0</span>, prob_choose[<span class="dv">7</span>],
                              prob_choose[<span class="dv">8</span>], <span class="dv">0</span>,
                              <span class="st">&quot;Target_For&quot;</span>, <span class="st">&quot;Target_Dom&quot;</span>,
                              <span class="st">&quot;Source_For&quot;</span>, <span class="st">&quot;Source_Dom&quot;</span>)
    
    P.TakeOver &lt;-<span class="st"> </span><span class="kw">parameters</span>(prob_choose[<span class="dv">9</span>], prob_choose[<span class="dv">10</span>],
                             prob_choose[<span class="dv">11</span>], prob_choose[<span class="dv">12</span>],
                             <span class="st">&quot;Target_For&quot;</span>, <span class="st">&quot;Target_Dom&quot;</span>,
                             <span class="st">&quot;Source_For&quot;</span>, <span class="st">&quot;Source_Dom&quot;</span>)
    multiplier &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># always 1 now.</span>
   <span class="cf">if</span> (count <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">4</span>) { 
        myOut &lt;-<span class="st"> </span><span class="kw">RunSimUltimate2</span>(myWorld, P.extinction, P.speciation, P.diffusion, P.Arisal, 
    P.TakeOver, nbs, independent, number_of_time_steps, multiplier, <span class="dt">silent =</span> <span class="ot">TRUE</span>, 
    count, <span class="dt">resolution =</span> <span class="kw">seq</span>(<span class="dv">1</span>, number_of_time_steps, <span class="dv">100</span>), P.Arisal0, <span class="dt">start =</span> <span class="ot">NULL</span>)
                            }
   <span class="cf">if</span> (count <span class="op">%in%</span><span class="st"> </span><span class="dv">5</span><span class="op">:</span><span class="dv">6</span>) {
        myOut &lt;-<span class="st"> </span><span class="kw">RunSimUltimate2.push</span>(myWorld, P.extinction, P.speciation, P.diffusion, P.Arisal, 
    P.TakeOver, nbs, independent, number_of_time_steps, multiplier, <span class="dt">silent =</span> <span class="ot">TRUE</span>, 
    count, <span class="dt">resolution =</span> <span class="kw">seq</span>(<span class="dv">1</span>, number_of_time_steps, <span class="dv">100</span>), P.Arisal0, <span class="dt">start =</span> <span class="ot">NULL</span>)
                            }
                            
                           
  }
  
}

#####################################################################
coords &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">apply</span>(language_centroids[, <span class="dv">3</span><span class="op">:</span><span class="dv">4</span>], <span class="dv">2</span>, as.numeric)) <span class="co">#coords</span>
conds &lt;-<span class="st"> </span><span class="kw">ifelse</span>(suitability2 <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)
conds[<span class="kw">is.na</span>(conds)] &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="kw">sum</span>(<span class="kw">is.na</span>(conds)), <span class="dt">replace =</span> <span class="ot">TRUE</span>) 
origins &lt;-<span class="st"> </span>language_centroids[, <span class="dv">5</span>]

##### Specify simulation parameters #################################

number_of_tips &lt;-<span class="st"> </span><span class="kw">length</span>(coords[,<span class="dv">1</span>])
number_of_time_steps_a &lt;-<span class="st"> </span><span class="dv">50000</span>
<span class="co">#replicate_cycle &lt;- c(1)  #number of replicates</span>
#####################################################################
<span class="kw">data</span>(<span class="st">&quot;parameters.table&quot;</span>)


<span class="kw">system.time</span>(
  myWorld &lt;-<span class="st"> </span><span class="kw">BuildWorld</span>(coords, conds)
)
number_of_neighbors &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">5</span><span class="op">:</span><span class="dv">9</span>,<span class="dv">1</span>)

nbs &lt;-<span class="st"> </span><span class="kw">knn2nb</span>(<span class="kw">knearneigh</span>(coords, <span class="dt">k =</span> number_of_neighbors, <span class="dt">longlat =</span> <span class="ot">TRUE</span>),
              <span class="dt">sym =</span> <span class="ot">TRUE</span>) <span class="co"># 7 symmetric neighbors</span>
n.obs &lt;-<span class="st"> </span><span class="kw">sapply</span>(nbs, length)
seq.max &lt;-<span class="st"> </span><span class="kw">seq_len</span>(<span class="kw">max</span>(n.obs))
nbs &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">sapply</span>(nbs, <span class="st">&quot;[&quot;</span>, <span class="dt">i =</span> seq.max))

<span class="kw">dim</span>(myWorld)


<span class="co"># NAI &lt;- 1000</span>
args &lt;-<span class="st"> </span><span class="kw">commandArgs</span>(<span class="dt">trailingOnly =</span> <span class="ot">FALSE</span>)
<span class="kw">print</span>(args)
NAI &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(args[<span class="dv">7</span>])
<span class="co">#setwd(&quot;~/Box Sync/colliding ranges/Simulations_humans/big world cluster outputs&quot;)</span>


<span class="co"># Starting point</span>
start &lt;-<span class="st"> </span><span class="kw">sample</span>((<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(language_centroids))[<span class="kw">as.logical</span>(language_centroids[, <span class="dv">6</span>])], <span class="dv">1</span>)

<span class="kw">sim_run_cluster</span>(<span class="dt">replicate_cycle =</span> NAI,
                myWorld, <span class="dt">number_of_time_steps =</span> number_of_time_steps_a, 
                nbs, <span class="dt">number_of_tips =</span> <span class="kw">nrow</span>(myWorld), <span class="dt">number_of_neighbors=</span> number_of_neighbors, <span class="dt">origins=</span>origins,<span class="dt">start =</span> start)</code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="module-2-space-and-phylogeny-summary-statistics.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="running-module-1-and-module-2-on-the-cluster.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/05_Call_modules_1_and_2.Rmd",
"text": "Edit"
},
"download": ["bookdown-demo.pdf", "bookdown-demo.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
